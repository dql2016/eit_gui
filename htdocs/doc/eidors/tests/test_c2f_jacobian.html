<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of test_c2f_jacobian</title>
  <meta name="keywords" content="test_c2f_jacobian">
  <meta name="description" content="Test calc of jacobian given coarse to fine mapping">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">tests</a> &gt; test_c2f_jacobian.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/tests&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>test_c2f_jacobian
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Test calc of jacobian given coarse to fine mapping</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function test_c2f_jacobian </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Test calc of jacobian given coarse to fine mapping

 (C) Andy Adler 2008. Licenced under GPL v2 or v3
 $Id: test_c2f_jacobian.m 3213 2012-06-29 20:31:29Z aadler $</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/deprecated/np_calc_image_prior.html" class="code" title="function Reg= np_calc_image_prior( inv_model );">np_calc_image_prior</a>	NP_CALC_IMAGE_PRIOR calculate image prior</li><li><a href="../../eidors/deprecated/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>	NP_CALC_JACOBIAN: J= np_calc_jacobian( fwd_model, img)</li><li><a href="../../eidors/deprecated/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>	NP_CALC_SYSTEM_MAT: s_mat= np_calc_system_mat( fwd_model, img)</li><li><a href="../../eidors/deprecated/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>	NP_FWD_SOLVE: data= np_fwd_solve( fwd_model, img)</li><li><a href="../../eidors/deprecated/np_inv_solve.html" class="code" title="function img= np_inv_solve( inv_model, data1, data2)">np_inv_solve</a>	NP_INV_SOLVE inverse solver for Nick Polydorides EIDORS3D code</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="../../eidors/models/mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>	MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM</li><li><a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>	JACOBIAN_ADJOINT: J= jacobian_adjoint( img )</li><li><a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="../../eidors/solvers/forward/system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>	SYSTEM_MAT_1ST_ORDER: SS= system_mat_1st_order( fwd_model, img)</li><li><a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function test1_np_3d</a></li><li><a href="#_sub2" class="code">function test2_aa_2d</a></li><li><a href="#_sub3" class="code">function test3_aa_3d</a></li><li><a href="#_sub4" class="code">function test4_npaa_3d</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function test_c2f_jacobian</a>
0002 <span class="comment">% Test calc of jacobian given coarse to fine mapping</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% (C) Andy Adler 2008. Licenced under GPL v2 or v3</span>
0005 <span class="comment">% $Id: test_c2f_jacobian.m 3213 2012-06-29 20:31:29Z aadler $</span>
0006 <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0007 
0008 <a href="#_sub1" class="code" title="subfunction test1_np_3d">test1_np_3d</a>
0009 <a href="#_sub2" class="code" title="subfunction test2_aa_2d">test2_aa_2d</a>
0010 <a href="#_sub3" class="code" title="subfunction test3_aa_3d">test3_aa_3d</a>
0011 <a href="#_sub4" class="code" title="subfunction test4_npaa_3d">test4_npaa_3d</a>
0012 
0013 <a name="_sub1" href="#_subfunctions" class="code">function test1_np_3d</a>
0014 <span class="comment">% Fine model</span>
0015 imdl = <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>);
0016 f1mdl = imdl.fwd_model;
0017 f1mdl.solve = @<a href="../../eidors/deprecated/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>;
0018 f1mdl.system_mat = @<a href="../../eidors/deprecated/np_calc_system_mat.html" class="code" title="function s_mat= np_calc_system_mat( fwd_model, img)">np_calc_system_mat</a>;
0019 f1mdl.jacobian   = @<a href="../../eidors/deprecated/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>;
0020 
0021 <span class="comment">% Create 2D FEM of all NODES with z=0</span>
0022 n2d = f1mdl.nodes( (f1mdl.nodes(:,3) == 0), 1:2);
0023 e2d = delaunayn(n2d);
0024 c_mdl = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'fwd_model'</span>,<span class="string">'2d'</span>,<span class="string">'elems'</span>,e2d,<span class="string">'nodes'</span>,n2d);
0025 
0026 <span class="comment">% Create f_mdl with coarse2fine mapping</span>
0027 c2f= <a href="../../eidors/models/mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>( f1mdl, c_mdl );
0028 f2mdl= f1mdl;
0029 f2mdl.coarse2fine = c2f;
0030 
0031 <span class="comment">% Just in case - define reconstruction</span>
0032 imdl.solve=       @<a href="../../eidors/deprecated/np_inv_solve.html" class="code" title="function img= np_inv_solve( inv_model, data1, data2)">np_inv_solve</a>;
0033 imdl.hyperparameter.value = 1e-3;
0034 imdl.R_prior= @<a href="../../eidors/deprecated/np_calc_image_prior.html" class="code" title="function Reg= np_calc_image_prior( inv_model );">np_calc_image_prior</a>;
0035 imdl.np_calc_image_prior.parameters= [3 1]; <span class="comment">% see iso_f_smooth: deg=1, w=1</span>
0036 imdl.jacobian_bkgnd.value= .6;
0037 imdl.reconst_type= <span class="string">'difference'</span>;
0038 imdl.fwd_model= f1mdl; <span class="comment">% fine model</span>
0039 
0040 img = <a href="../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>( imdl);
0041 
0042 t=cputime;
0043 J1= <a href="../../eidors/deprecated/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>( f1mdl, img)*c2f;
0044 fprintf(<span class="string">'np_calc - full: t=%f\n'</span>,  cputime-t  );
0045 n_J1 = norm(J1,<span class="string">'fro'</span>);
0046 
0047 t=cputime;
0048 J2= <a href="../../eidors/deprecated/np_calc_jacobian.html" class="code" title="function J= np_calc_jacobian( fwd_model, img)">np_calc_jacobian</a>( f2mdl, img);
0049 fprintf(<span class="string">'np_calc - c2f: t=%f\n'</span>,  cputime-t  );
0050 
0051 n_J1_J2 = norm(J1-J2,<span class="string">'fro'</span>)/ n_J1;
0052 <span class="keyword">if</span> n_J1_J2 &gt; 1e-4; 
0053    warning(<span class="string">'J1-J2 is too big'</span>);
0054 <span class="keyword">end</span>
0055 
0056 
0057 t=cputime;
0058 J2p= <a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>( f2mdl, img);
0059 fprintf(<span class="string">'perturb_j - c2f: t=%f\n'</span>,  cputime-t  );
0060 
0061 n_J1_J2p = norm(J1-J2p,<span class="string">'fro'</span>)/ n_J1;
0062 <span class="keyword">if</span> n_J1_J2p &gt; 1e-4; 
0063    warning(<span class="string">'J1-J2p is too big'</span>);
0064 <span class="keyword">end</span>
0065 
0066 
0067 
0068 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0069 <a name="_sub2" href="#_subfunctions" class="code">function test2_aa_2d</a>
0070 
0071 imdl= <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,16);
0072 cmdl = imdl.fwd_model;
0073 imdl= <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c2c0'</span>,16);
0074 f1mdl = imdl.fwd_model;
0075 
0076 c2f= <a href="../../eidors/models/mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>(f1mdl,cmdl);
0077 img= <a href="../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(imdl);
0078 
0079 t=cputime;
0080 J1= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f1mdl, img)*c2f;
0081 fprintf(<span class="string">'aa_calc - full: t=%f\n'</span>,  cputime-t  );
0082 n_J1 = norm(J1,<span class="string">'fro'</span>);
0083 
0084 f2mdl= f1mdl;
0085 f2mdl.coarse2fine = c2f;
0086 
0087 <span class="comment">%%%%%%%%%% J2</span>
0088 t=cputime;
0089 J2= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f2mdl, img);
0090 fprintf(<span class="string">'aa_calc - c2f: t=%f\n'</span>,  cputime-t  );
0091 
0092 n_J1_J2 = norm(J1-J2,<span class="string">'fro'</span>)/ n_J1;
0093 <span class="keyword">if</span> n_J1_J2 &gt; 1e-4; 
0094    warning(<span class="string">'J1-J2 is too big'</span>);
0095 keyboard
0096 <span class="keyword">end</span>
0097 
0098 
0099 <span class="comment">%%%%%%%%%% J2p</span>
0100 t=cputime;
0101 J2p= <a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>( f2mdl, img);
0102 fprintf(<span class="string">'perturb_j - c2f: t=%f\n'</span>,  cputime-t  );
0103 
0104 n_J1_J2p = norm(J1-J2p,<span class="string">'fro'</span>)/ n_J1;
0105 
0106 <span class="keyword">if</span> n_J1_J2p &gt; 1e-4; 
0107    warning(<span class="string">'J1-J2p is too big'</span>);
0108 <span class="keyword">end</span>
0109 
0110 <span class="comment">%%%%%%%%%% J1p</span>
0111 t=cputime;
0112 J1p= <a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>( f1mdl, img)*c2f;
0113 fprintf(<span class="string">'perturb_j - full: t=%f\n'</span>,  cputime-t  );
0114 
0115 n_J1_J1p = norm(J1-J1p,<span class="string">'fro'</span>)/ n_J1;
0116 <span class="keyword">if</span> n_J1_J1p &gt; 1e-4; 
0117    warning(<span class="string">'J1-J1p is too big'</span>);
0118 <span class="keyword">end</span>
0119 
0120 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0121 <a name="_sub3" href="#_subfunctions" class="code">function test3_aa_3d</a>
0122 
0123 imdl= <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,16);
0124 cmdl = imdl.fwd_model;
0125 imdl= <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a3cr'</span>,16);
0126 f1mdl = imdl.fwd_model;
0127 
0128 c2f= <a href="../../eidors/models/mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>(f1mdl,cmdl);
0129 img= <a href="../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(imdl);
0130 
0131 t=cputime;
0132 J1= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f1mdl, img)*c2f;
0133 fprintf(<span class="string">'aa_calc - full: t=%f\n'</span>,  cputime-t  );
0134 n_J1 = norm(J1,<span class="string">'fro'</span>);
0135 
0136 f2mdl= f1mdl;
0137 f2mdl.coarse2fine = c2f;
0138 
0139 <span class="comment">%%%%%%%%%% J2</span>
0140 t=cputime;
0141 J2= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f2mdl, img);
0142 fprintf(<span class="string">'aa_calc - c2f: t=%f\n'</span>,  cputime-t  );
0143 
0144 n_J1_J2 = norm(J1-J2,<span class="string">'fro'</span>)/ n_J1;
0145 <span class="keyword">if</span> n_J1_J2 &gt; 1e-4; 
0146    warning(<span class="string">'J1-J2 is too big'</span>);
0147 keyboard
0148 <span class="keyword">end</span>
0149 
0150 
0151 <span class="comment">%%%%%%%%%% J2p</span>
0152 t=cputime;
0153 J2p= <a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>( f2mdl, img);
0154 fprintf(<span class="string">'perturb_j - c2f: t=%f\n'</span>,  cputime-t  );
0155 
0156 n_J1_J2p = norm(J1-J2p,<span class="string">'fro'</span>)/ n_J1;
0157 
0158 <span class="keyword">if</span> n_J1_J2p &gt; 1e-4; 
0159    warning(<span class="string">'J1-J2p is too big'</span>);
0160 <span class="keyword">end</span>
0161 
0162 <a name="_sub4" href="#_subfunctions" class="code">function test4_npaa_3d</a>
0163 <span class="comment">% Fine model</span>
0164 imdl = <a href="../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>);
0165 f1mdl = imdl.fwd_model;
0166 f1mdl.solve = @<a href="../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>;
0167 f1mdl.jacobian = @<a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>;
0168 f1mdl.system_mat = @<a href="../../eidors/solvers/forward/system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>;
0169 
0170 <span class="comment">% Create 2D FEM of all NODES with z=0</span>
0171 n2d = f1mdl.nodes( (f1mdl.nodes(:,3) == 0), 1:2);
0172 e2d = delaunayn(n2d);
0173 c_mdl = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'fwd_model'</span>,<span class="string">'2d'</span>,<span class="string">'elems'</span>,e2d,<span class="string">'nodes'</span>,n2d);
0174 
0175 <span class="comment">% Create f_mdl with coarse2fine mapping</span>
0176 c2f= <a href="../../eidors/models/mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>( f1mdl, c_mdl );
0177 f2mdl= f1mdl;
0178 f2mdl.coarse2fine = c2f;
0179 
0180 imdl.jacobian_bkgnd.value= .6;
0181 img = <a href="../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>( imdl);
0182 
0183 t=cputime;
0184 J1= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f1mdl, img)*c2f;
0185 fprintf(<span class="string">'aa_calc - full: t=%f\n'</span>,  cputime-t  );
0186 n_J1 = norm(J1,<span class="string">'fro'</span>);
0187 
0188 t=cputime;
0189 J2= <a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>( f2mdl, img);
0190 fprintf(<span class="string">'aa_calc - c2f: t=%f\n'</span>,  cputime-t  );
0191 
0192 n_J1_J2 = norm(J1-J2,<span class="string">'fro'</span>)/ n_J1;
0193 <span class="keyword">if</span> n_J1_J2 &gt; 1e-4; 
0194    warning(<span class="string">'J1-J2 is too big'</span>);
0195 <span class="keyword">end</span>
0196 
0197 
0198 t=cputime;
0199 J2p= <a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>( f2mdl, img);
0200 fprintf(<span class="string">'perturb_j - c2f: t=%f\n'</span>,  cputime-t  );
0201 
0202 n_J1_J2p = norm(J1-J2p,<span class="string">'fro'</span>)/ n_J1;
0203 <span class="keyword">if</span> n_J1_J2p &gt; 1e-4; 
0204    warning(<span class="string">'J1-J2p is too big'</span>);
0205 <span class="keyword">end</span>
0206</pre></div>
<hr><address>Generated on Fri 01-Jun-2018 15:59:55 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>