<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of data_mapper</title>
  <meta name="keywords" content="data_mapper">
  <meta name="description" content="DATA_MAPPER maps img.params data to elem or node data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; data_mapper.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>data_mapper
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>DATA_MAPPER maps img.params data to elem or node data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function img = data_mapper(img, reverse) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">DATA_MAPPER maps img.params data to elem or node data
 img = data_mapper(img) will only work if there is only a single
 params data field on the img, throwing an error otherwise.
 For multi-parametrization images, img.data_mapper must be specified. It
 can be either a name of the appropriate parametrization data field on the img, or
 a function that will handle the data differently.

 To avoid confusion, the parametrization currently in use by image data will be
 specified in a descriptive string tag img.current_params

 img = data_mapper(img, TRUE) will reverse the process updating
 the current parametrization with the data from img.elem_data or img.node_data.

 Examples:
  imdl = mk_common_model('a2c2',8);
  c = 3*ones(length(imdl.fwd_model.elems),1);
  img = eidors_obj('image','fwd_model',imdl.fwd_model);
  img.conductivity.elem_data = c;
  img = data_mapper(img);

  img.resistivity.elem_data = 1./c;
  img.data_mapper = 'resistivity';
  img = data_mapper(img);

  img.data_mapper = 'some_function_that_takes_an_image';
  img = data_mapper(img);

 KNOWN ISSUES:
   - doesn't fully support image arrays

 See also: <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">MK_IMAGE</a>, <a href="supported_params.html" class="code" title="function list = supported_params">SUPPORTED_PARAMS</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/graphics/matlab/calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>	calc_slices (img, levels, clim  ) show slices at levels of an</li><li><a href="../../eidors/graphics/matlab/show_3d_slices.html" class="code" title="function h = show_3d_slices(img, varargin);">show_3d_slices</a>	show_3d_slices(img, z_cuts, x_cuts, y_cuts, any_cuts)</li><li><a href="../../eidors/graphics/matlab/show_fem_move.html" class="code" title="function [hf,hh] = show_fem_move( img, move, scale, options )">show_fem_move</a>	SHOW_FEM_MOVE   Plot EIT finite element model (FEM) and movement</li><li><a href="convert_img_units.html" class="code" title="function y = convert_img_units(img,arg1,arg2)">convert_img_units</a>	CONVERT_IMG_UNITS change image data units</li><li><a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="../../eidors/solvers/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>	CALC_JACOBIAN: calculate jacobian from an inv_model</li><li><a href="../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../eidors/solvers/forward/fwd_solve_2p5d_1st_order.html" class="code" title="function data =fwd_solve_2p5d_1st_order(fwd_model, img)">fwd_solve_2p5d_1st_order</a>	FWD_SOLVE_2P5D_1ST_ORDER: data= fwd_solve_2p5d_1st_order( img)</li><li><a href="../../eidors/solvers/forward/fwd_solve_halfspace.html" class="code" title="function data = fwd_solve_halfspace(fwd_model, img)">fwd_solve_halfspace</a>	FWD_SOLVE_HALFSPACE: data = fwd_solve_halfspace(img)</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>	JACOBIAN_ADJOINT: J= jacobian_adjoint( img )</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint_2p5d_1st_order.html" class="code" title="function J= jacobian_adjoint_2p5d_1st_order( fwd_model, img)">jacobian_adjoint_2p5d_1st_order</a>	JACOBIAN_ADJOINT_2P5D: J= jacobian_adjoint_2p5d_1st_order( img )</li><li><a href="../../eidors/solvers/forward/jacobian_movement_2p5d_1st_order.html" class="code" title="function J = jacobian_movement_2p5d_1st_order( fwd_model, img)">jacobian_movement_2p5d_1st_order</a>	JACOBIAN_MOVEMENT_2P5D: J = jacobian_movement_2p5d_1st_order( img )</li><li><a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../eidors/solvers/inverse/calc_noise_figure.html" class="code" title="function [NF,SE] = calc_noise_figure( inv_model, hp, iterations)">calc_noise_figure</a>	CALC_NOISE_FIGURE: calculate the noise amplification (NF) of an algorithm</li><li><a href="../../eidors/solvers/inverse/calc_solution_error.html" class="code" title="function [e res] = calc_solution_error(imgc, imdl, vh, vi)">calc_solution_error</a>	CALC_SOLUTION_ERROR Calculate residuals for a solution</li><li><a href="../../eidors/solvers/inverse/inv_solve_core.html" class="code" title="function img= inv_solve_core( inv_model, data0, data1);">inv_solve_core</a>	INV_SOLVE_CORE Solver using a generic iterative algorithm</li><li><a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>	INV_SOLVE_DIFF_GN_ONE_STEP inverse solver using approach of Adler&Guardo 1996</li><li><a href="../../eidors/solvers/inverse/line_optimize.html" class="code" title="function [img fmin res] = line_optimize(imgk, dx, data0, opt)">line_optimize</a>	LINE_OPTIMIZE Cheap line optimizer</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function img = pack_params(img);</a></li><li><a href="#_sub2" class="code">function img = pack_params_using_params_str(img, prms)</a></li><li><a href="#_sub3" class="code">function n = calc_num_elems(fmdl)</a></li><li><a href="#_sub4" class="code">function img = copy_data_to_params(img, prms)</a></li><li><a href="#_sub5" class="code">function img = unpack_params(img)</a></li><li><a href="#_sub6" class="code">function pass = do_unit_test</a></li><li><a href="#_sub7" class="code">function pass = do_unit_test_legacy</a></li><li><a href="#_sub8" class="code">function img = unit_test_passthrough(img1,rev)</a></li><li><a href="#_sub9" class="code">function pass = do_unit_test_undo</a></li><li><a href="#_sub10" class="code">function pass = test_undo(img, d, dl)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function img = data_mapper(img, reverse)</a>
0002 <span class="comment">%DATA_MAPPER maps img.params data to elem or node data</span>
0003 <span class="comment">% img = data_mapper(img) will only work if there is only a single</span>
0004 <span class="comment">% params data field on the img, throwing an error otherwise.</span>
0005 <span class="comment">% For multi-parametrization images, img.data_mapper must be specified. It</span>
0006 <span class="comment">% can be either a name of the appropriate parametrization data field on the img, or</span>
0007 <span class="comment">% a function that will handle the data differently.</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% To avoid confusion, the parametrization currently in use by image data will be</span>
0010 <span class="comment">% specified in a descriptive string tag img.current_params</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% img = data_mapper(img, TRUE) will reverse the process updating</span>
0013 <span class="comment">% the current parametrization with the data from img.elem_data or img.node_data.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Examples:</span>
0016 <span class="comment">%  imdl = mk_common_model('a2c2',8);</span>
0017 <span class="comment">%  c = 3*ones(length(imdl.fwd_model.elems),1);</span>
0018 <span class="comment">%  img = eidors_obj('image','fwd_model',imdl.fwd_model);</span>
0019 <span class="comment">%  img.conductivity.elem_data = c;</span>
0020 <span class="comment">%  img = data_mapper(img);</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%  img.resistivity.elem_data = 1./c;</span>
0023 <span class="comment">%  img.data_mapper = 'resistivity';</span>
0024 <span class="comment">%  img = data_mapper(img);</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  img.data_mapper = 'some_function_that_takes_an_image';</span>
0027 <span class="comment">%  img = data_mapper(img);</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% KNOWN ISSUES:</span>
0030 <span class="comment">%   - doesn't fully support image arrays</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% See also: MK_IMAGE, SUPPORTED_PARAMS</span>
0033 
0034 <span class="comment">% (C) 2012 Bartlomiej Grychtol.</span>
0035 <span class="comment">% Licenced under GPL version 2 or 3</span>
0036 <span class="comment">% $Id: data_mapper.m 5112 2015-06-14 13:00:41Z aadler $</span>
0037 
0038 <span class="keyword">if</span> ischar(img) &amp;&amp; strcmp(img,<span class="string">'UNIT_TEST'</span>); img = <a href="#_sub6" class="code" title="subfunction pass = do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0039 
0040 <span class="keyword">if</span> nargin &lt; 2
0041    reverse = false;
0042 <span class="keyword">elseif</span> ischar(reverse) &amp;&amp; strcmpi(reverse, <span class="string">'pack'</span>)
0043    reverse = false;
0044 <span class="keyword">else</span> <span class="comment">% 'unpack'</span>
0045    reverse = true;
0046 <span class="keyword">end</span>
0047 <span class="comment">% need to handle image arrays</span>
0048 <span class="keyword">for</span> i = 1:length(img)
0049    <span class="keyword">if</span> reverse
0050       tmp(i) = <a href="#_sub5" class="code" title="subfunction img = unpack_params(img)">unpack_params</a>(img(i));
0051    <span class="keyword">else</span>
0052       tmp(i) = <a href="#_sub1" class="code" title="subfunction img = pack_params(img);">pack_params</a>(img(i));
0053    <span class="keyword">end</span>
0054 <span class="keyword">end</span>
0055 img = tmp;
0056 <span class="keyword">end</span>
0057 
0058 <a name="_sub1" href="#_subfunctions" class="code">function img = pack_params(img);</a>
0059 
0060 flds = fieldnames(img);
0061 prms = ismember(flds, <a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>);
0062 
0063 <span class="keyword">switch</span> sum(prms)
0064    <span class="keyword">case</span> 0
0065       <span class="comment">% no params found, check for elem_data or node_data</span>
0066       <span class="keyword">if</span> ~( isfield(img,<span class="string">'elem_data'</span>) || isfield(img,<span class="string">'node_data'</span>))
0067          error(<span class="string">'No params, elem_data or node_data found on img'</span>);
0068       <span class="keyword">else</span>
0069          <span class="keyword">if</span> isfield(img,<span class="string">'current_params'</span>) &amp;&amp; ~isempty(img.current_params)
0070                 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ Careful! Image already mapped. Doing nothing'</span>,4);
0071            <span class="keyword">return</span>;
0072          <span class="keyword">end</span>
0073 
0074          <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ No params present on img. Assuming conductivity'</span>,4);
0075 <span class="comment">% STUPID MATLAB CAN'T KEEP SYNTAX STRAIGHT BETWEEN VERSIONS</span>
0076 <span class="comment">%        img = setfield(img,{},'current_params', 'conductivity');</span>
0077 <span class="comment">% NEED TO DO THIS, UGLY INEFFICIENT CODE</span>
0078          <span class="keyword">for</span> i=1:length(img)
0079             img(i).current_params = <span class="string">'conductivity'</span>;
0080          <span class="keyword">end</span>
0081       <span class="keyword">end</span>
0082       <span class="keyword">return</span>      <span class="comment">% returns img</span>
0083    <span class="keyword">case</span> 1
0084       ph = find(prms);
0085       <span class="keyword">if</span> isfield(img.(flds{ph}),<span class="string">'func'</span>)
0086          <span class="comment">% let the function handle the whole process</span>
0087          img = feval(img.(flds{ph}).func, img);
0088          <span class="keyword">return</span>
0089       <span class="keyword">else</span>
0090          img = <a href="#_sub2" class="code" title="subfunction img = pack_params_using_params_str(img, prms)">pack_params_using_params_str</a>(img, flds{ph});
0091       <span class="keyword">end</span>
0092    <span class="keyword">otherwise</span>
0093       <span class="comment">% multiple params</span>
0094       <span class="keyword">try</span>
0095          prms_fun = img.data_mapper;
0096       <span class="keyword">catch</span>
0097          error(<span class="string">'Multiple params found on img require: img.data_mapper = function or {&quot;string&quot;,&quot;array&quot;}'</span>);
0098       <span class="keyword">end</span>
0099       <span class="keyword">if</span> ~isa(prms_fun, <span class="string">'function_handle'</span>) &amp;&amp; ismember(prms_fun,flds);
0100          img = <a href="#_sub2" class="code" title="subfunction img = pack_params_using_params_str(img, prms)">pack_params_using_params_str</a>(img, prms_fun); <span class="comment">% assume a string array</span>
0101       <span class="keyword">else</span>
0102          <span class="keyword">try</span>
0103             img = feval(prms_fun,img);
0104          <span class="keyword">catch</span>
0105             error(<span class="string">'img.data_mapper not understood'</span>);
0106          <span class="keyword">end</span>
0107       <span class="keyword">end</span>
0108 
0109 <span class="keyword">end</span>
0110 <span class="keyword">end</span>
0111 
0112 <a name="_sub2" href="#_subfunctions" class="code">function img = pack_params_using_params_str(img, prms)</a>
0113 
0114 prms_flds = fieldnames(img.(prms));
0115 <span class="keyword">for</span> i = 1:length(prms_flds)
0116    <span class="keyword">if</span> isfield(img, prms_flds{i})
0117       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ Overwriting img.%s'</span>,prms_flds{i},4);
0118       warning(<span class="string">'EIDORS:OverwritingData'</span>, <span class="string">'Overwriting img.%s'</span>,prms_flds{i});
0119    <span class="keyword">end</span>
0120    <span class="comment">% allow elem_data/node_data to be scalar</span>
0121    <span class="keyword">if</span> strcmp(prms_flds{i},<span class="string">'elem_data'</span>) &amp;&amp; numel(img.(prms).elem_data) == 1
0122       n_elem = <a href="#_sub3" class="code" title="subfunction n = calc_num_elems(fmdl)">calc_num_elems</a>(img.fwd_model);
0123       img.elem_data = ones(n_elem,1);
0124       img.elem_data(:) = img.(prms).elem_data;
0125    <span class="keyword">elseif</span> strcmp(prms_flds{i},<span class="string">'node_data'</span>)
0126       img.node_data = ones(size(img.fwd_model.nodes,1),1);
0127       img.node_data(:) = img.(prms).node_data;
0128    <span class="keyword">else</span>
0129       img.(prms_flds{i}) = img.(prms).(prms_flds{i});
0130    <span class="keyword">end</span>
0131 <span class="keyword">end</span>
0132 img.current_params = prms;
0133 <span class="keyword">end</span>
0134 
0135 <a name="_sub3" href="#_subfunctions" class="code">function n = calc_num_elems(fmdl)</a>
0136 <span class="keyword">if</span> isfield(fmdl, <span class="string">'coarse2fine'</span>)
0137    n = size(fmdl.coarse2fine,2);
0138 <span class="keyword">else</span>
0139    n = length(fmdl.elems);
0140 <span class="keyword">end</span>
0141 <span class="keyword">end</span>
0142 
0143 <a name="_sub4" href="#_subfunctions" class="code">function img = copy_data_to_params(img, prms)</a>
0144 prms_flds = fieldnames(img.(prms));
0145 <span class="keyword">try</span>
0146    <span class="keyword">for</span> i = 1:length(prms_flds)
0147       img.(prms).(prms_flds{i}) = img.(prms_flds{i});
0148       img = rmfield(img, prms_flds{i});
0149    <span class="keyword">end</span>
0150    img = rmfield(img, <span class="string">'current_params'</span>);
0151 <span class="keyword">catch</span>
0152    error(<span class="string">'Fields specified by img.%s missing from img.'</span>,prms);
0153 <span class="keyword">end</span>
0154 <span class="keyword">end</span>
0155 
0156 <a name="_sub5" href="#_subfunctions" class="code">function img = unpack_params(img)</a>
0157 <span class="keyword">try</span>
0158    curprms = img.current_params;
0159 <span class="keyword">catch</span>
0160    <span class="keyword">if</span> isfield(img,<span class="string">'elem_data'</span>) || isfield(img, <span class="string">'node_data'</span>)
0161       <span class="keyword">return</span> <span class="comment">% old type image, nothing to do</span>
0162    <span class="keyword">else</span>
0163       error(<span class="string">'img.current_params required'</span>);
0164    <span class="keyword">end</span>
0165 <span class="keyword">end</span>
0166 <span class="keyword">if</span> ismember(curprms, fieldnames(img))
0167    img = <a href="#_sub4" class="code" title="subfunction img = copy_data_to_params(img, prms)">copy_data_to_params</a>(img,curprms);
0168 <span class="keyword">elseif</span> strcmp(curprms,<span class="string">'conductivity'</span>)
0169    <span class="comment">% current_params is conductivity, but there's no img.conductivity</span>
0170    <span class="keyword">if</span> ~any(ismember(fieldnames(img),<a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>))
0171       <span class="comment">% we're dealing with an old params-oblivious image</span>
0172       <span class="comment">% nothing to do</span>
0173       img = rmfield(img, <span class="string">'current_params'</span>);
0174    <span class="keyword">else</span>
0175       error(<span class="string">'Cannot reverse %s mapping'</span>,curprms);
0176    <span class="keyword">end</span>
0177 <span class="keyword">else</span>
0178    <span class="keyword">try</span>
0179       <span class="comment">% user-provided data_mapper must provide the reverse</span>
0180       img = feval(curprms,img,1);
0181    <span class="keyword">catch</span>
0182       error(<span class="string">'data_mapper %s failed to reverse'</span>, curprms);
0183    <span class="keyword">end</span>
0184 <span class="keyword">end</span>
0185 <span class="keyword">end</span>
0186 
0187 <a name="_sub6" href="#_subfunctions" class="code">function pass = do_unit_test</a>
0188    pass = 1;
0189    pass = <a href="#_sub7" class="code" title="subfunction pass = do_unit_test_legacy">do_unit_test_legacy</a>() &amp;&amp; pass;
0190    pass = <a href="#_sub9" class="code" title="subfunction pass = do_unit_test_undo">do_unit_test_undo</a>()   &amp;&amp; pass;
0191    disp(<span class="string">''</span>);
0192    <span class="keyword">if</span> pass
0193       disp(<span class="string">'TEST: overall PASS'</span>);
0194    <span class="keyword">else</span>
0195       error(<span class="string">'TEST: overall FAIL'</span>);
0196    <span class="keyword">end</span>
0197 <span class="keyword">end</span>
0198 
0199 <a name="_sub7" href="#_subfunctions" class="code">function pass = do_unit_test_legacy</a>
0200    pass = 1;
0201    ll = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>);
0202    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,3);
0203 
0204    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,8);
0205    c = 3*ones(length(imdl.fwd_model.elems),1);
0206    img = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'test_image'</span>,<span class="string">'fwd_model'</span>,imdl.fwd_model);
0207    img.conductivity.elem_data = c;
0208 
0209    fprintf(<span class="string">'TEST: mv img.conductivity.elem_data to img.elem_data\n'</span>);
0210    imgi = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img, <span class="string">'pack'</span>);
0211    <span class="keyword">if</span> ~isfield(imgi, <span class="string">'elem_data'</span>)
0212      imgi
0213      disp(<span class="string">'TEST FAIL: missing elem_data'</span>);
0214      pass = 0;
0215    <span class="keyword">end</span>
0216 
0217    imgi2 = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img, <span class="string">'pack'</span>); <span class="comment">% give a msg at log_level 3</span>
0218 
0219    imgii = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(imgi,<span class="string">'unpack'</span>); <span class="comment">% unpack</span>
0220    <span class="keyword">if</span> ~isequaln(imgii, img)
0221       img
0222       imgii
0223       fprintf(<span class="string">'TEST FAIL: pack to unpack returned different result\n'</span>);
0224       pass = 0;
0225    <span class="keyword">end</span>
0226 
0227    img.resistivity.elem_data = 1./c;
0228    img.data_mapper = <span class="string">'resistivity'</span>;
0229    img = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0230    <span class="keyword">if</span> abs(img.elem_data(1) - 1/3) &gt; 1e-4
0231       img.elem_data(1)
0232       pass = 0;
0233       disp(<span class="string">'TEST FAIL: expected img.elem_data to be ~1/3'</span>);
0234    <span class="keyword">end</span>
0235 
0236    img.data_mapper = @<a href="#_sub8" class="code" title="subfunction img = unit_test_passthrough(img1,rev)">unit_test_passthrough</a>; <span class="comment">% some function that takes an image</span>
0237    imgf = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0238    <span class="comment">% if this works without failing, then we are happy</span>
0239    <span class="keyword">if</span> ~isequaln(imgf, img)
0240       img
0241       imgf
0242       fprintf(<span class="string">'TEST FAIL: pass-through function failed\n'</span>);
0243       pass = 0;
0244    <span class="keyword">end</span>
0245 
0246    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,ll);
0247    <span class="keyword">if</span> ~pass
0248       disp(<span class="string">'TEST: ---------------------------------------'</span>);
0249    <span class="keyword">end</span>
0250 <span class="keyword">end</span>
0251 
0252 <a name="_sub8" href="#_subfunctions" class="code">function img = unit_test_passthrough(img1,rev)</a>
0253   img = img1;
0254 <span class="keyword">end</span>
0255 
0256 <a name="_sub9" href="#_subfunctions" class="code">function pass = do_unit_test_undo</a>
0257    pass = 1;
0258 
0259    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c2c'</span>, 16);
0260    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl);
0261    d = img.elem_data;
0262    img0 = rmfield(img, <span class="string">'elem_data'</span>);
0263 
0264    disp(<span class="string">'TEST: img.elem_data'</span>);
0265    img = img0; img.elem_data = d;
0266    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'elem_data'</span>) &amp;&amp; pass;
0267 
0268    disp(<span class="string">'TEST: img.node_data'</span>);
0269    img = img0; img.node_data = d;
0270    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'node_data'</span>) &amp;&amp; pass;
0271 
0272    disp(<span class="string">'TEST: img.conductivity.elem_data'</span>);
0273    img = img0; img.conductivity.elem_data = d;
0274    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'elem_data'</span>) &amp;&amp; pass;
0275 <span class="comment">% TODO AB below here blows up</span>
0276 <span class="comment">%   disp('TEST: img.conductivity.node_data');</span>
0277 <span class="comment">%   img = img0; img.conductivity.node_data = d;</span>
0278 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0279 
0280 <span class="comment">%   disp('TEST: img.resistivity.node_data');</span>
0281 <span class="comment">%   img = img0; img.resistivity.node_data = d;</span>
0282 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0283 
0284 <span class="comment">%   disp('TEST: img.conductivity');</span>
0285 <span class="comment">%   img = img0; img.conductivity = d; img.params_mapper = 'conductivity';</span>
0286 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0287 <span class="keyword">end</span>
0288 
0289 <span class="comment">% img, d=data, dl=data location (once packed)</span>
0290 <a name="_sub10" href="#_subfunctions" class="code">function pass = test_undo(img, d, dl)</a>
0291    pass = 1;
0292    imgp = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0293    imgup = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(imgp,<span class="string">'unpack'</span>);
0294    <span class="keyword">if</span> ~isequaln(img, imgup)
0295       img
0296       imgp
0297       imgup
0298       disp(<span class="string">'TEST FAIL: the initial image and the image after being packed, then unpacked differ'</span>);
0299       pass = 0;
0300    <span class="keyword">end</span>
0301    <span class="keyword">if</span> ~isequaln(imgp.(dl), d)
0302       disp([<span class="string">'TEST FAIL: the packed data imgp.'</span> dl <span class="string">' seems broken'</span>]);
0303       pass = 0;
0304    <span class="keyword">end</span>
0305    <span class="keyword">if</span> ~pass
0306       disp(<span class="string">'TEST: ---------------------------------------'</span>);
0307    <span class="keyword">end</span>
0308 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 01-Jun-2018 15:59:55 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>