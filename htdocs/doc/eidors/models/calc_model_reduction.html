<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calc_model_reduction</title>
  <meta name="keywords" content="calc_model_reduction">
  <meta name="description" content="calc_model_reduction: calculate the fields for a reduced model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; calc_model_reduction.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>calc_model_reduction
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>calc_model_reduction: calculate the fields for a reduced model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function mr = calc_model_reduction(fmdl) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> calc_model_reduction: calculate the fields for a reduced model
    which should speed up forward calculations
 
 mr = calc_model_reducton(fmdl)
  where
    mr.main_region = vector, and 
    mr.regions = struct

 Model Reduction: use precomputed fields to reduce the size of
    the forward solution. Nodes which are 1) not used in the output
    (i.e. not electrodes) 2) all connected to the same conductivity via
    the c2f mapping are applicable.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="calc_model_reduction.html" class="code" title="function mr = calc_model_reduction(fmdl)">calc_model_reduction</a>	calc_model_reduction: calculate the fields for a reduced model</li><li><a href="elem_dim.html" class="code" title="function num = elem_dim( mdl );">elem_dim</a>	ELEM_DIM: dimension of elements in space (are elements in 2D or 3D space)</li><li><a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>	MK_STIM_PATTERNS: create an EIDORS stimulation pattern structure</li><li><a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../eidors/solvers/forward/system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>	SYSTEM_MAT_FIELDS: fields (elem to nodes) fraction of system mat</li><li><a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="calc_model_reduction.html" class="code" title="function mr = calc_model_reduction(fmdl)">calc_model_reduction</a>	calc_model_reduction: calculate the fields for a reduced model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function mr = calc_model_reduction_fn(fwd_model);</a></li><li><a href="#_sub2" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function mr = calc_model_reduction(fmdl)</a>
0002 <span class="comment">% calc_model_reduction: calculate the fields for a reduced model</span>
0003 <span class="comment">%    which should speed up forward calculations</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% mr = calc_model_reducton(fmdl)</span>
0006 <span class="comment">%  where</span>
0007 <span class="comment">%    mr.main_region = vector, and</span>
0008 <span class="comment">%    mr.regions = struct</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Model Reduction: use precomputed fields to reduce the size of</span>
0011 <span class="comment">%    the forward solution. Nodes which are 1) not used in the output</span>
0012 <span class="comment">%    (i.e. not electrodes) 2) all connected to the same conductivity via</span>
0013 <span class="comment">%    the c2f mapping are applicable.</span>
0014 
0015 <span class="comment">% see: Model Reduction for FEM Forward Solutions, Adler &amp; Lionheart, EIT2016</span>
0016 
0017 <span class="comment">% $Id: calc_model_reduction.m 5789 2018-05-21 23:39:41Z aadler $</span>
0018 
0019 <span class="keyword">if</span> ischar(fmdl) &amp;&amp; strcmp(fmdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub2" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0020 
0021 <span class="keyword">switch</span> fmdl(1).type
0022   <span class="keyword">case</span> <span class="string">'image'</span>;      fmdl = fmdl.fwd_model;
0023   <span class="keyword">case</span> <span class="string">'inv_model'</span>;  fmdl = fmdl.fwd_model;
0024   <span class="keyword">case</span> <span class="string">'fwd_model'</span>;  fmdl = fmdl;
0025   <span class="keyword">otherwise</span>;
0026       error(<span class="string">'cant process model of type %s'</span>, fmdl.type );
0027 <span class="keyword">end</span>
0028 
0029 <span class="keyword">if</span> ~isfield(fmdl,<span class="string">'coarse2fine'</span>);
0030    FC = <a href="../../eidors/solvers/forward/system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>(fmdl);
0031    mr.main_region = logical(ones(1,size(FC,2))'); 
0032    mr.regions     = struct([]);
0033    <span class="keyword">return</span>
0034 <span class="keyword">end</span> <span class="comment">% not needed without</span>
0035 
0036 
0037 copt.cache_obj.elems = fmdl.elems;
0038 copt.cache_obj.nodes = fmdl.nodes;
0039 copt.cache_obj.coarse2fine = fmdl.coarse2fine;
0040 copt.fstr = <span class="string">'calc_model_reducton'</span>;
0041 copt.log_level = 4;
0042 mr= <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub1" class="code" title="subfunction mr = calc_model_reduction_fn(fwd_model);">calc_model_reduction_fn</a>,{fmdl},copt );
0043 
0044 <a name="_sub1" href="#_subfunctions" class="code">function mr = calc_model_reduction_fn(fwd_model);</a>
0045    ne = <a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(fwd_model);
0046    el = fwd_model.elems; ei=(1:ne)';
0047    e2n = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(el,ei*ones(1,<a href="elem_dim.html" class="code" title="function num = elem_dim( mdl );">elem_dim</a>(fwd_model)+1),1);
0048 
0049    c2n = e2n*fwd_model.coarse2fine;
0050 
0051 <span class="comment">% get the number of the c2n mapping. But only work on those with one</span>
0052    ac2n = c2n&gt;0;
0053    ac2n(sum(ac2n,2)&gt;1,:) = 0;
0054    region = ac2n*(1:size(ac2n,2))';
0055    region0 = region==0;
0056    FC = <a href="../../eidors/solvers/forward/system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>(fwd_model); S= FC'*FC;
0057    region0(end+1:size(FC,2)) = logical(1);
0058    k=0;
0059    <span class="keyword">for</span> i=1:max(region);
0060       ff=find(region==i);
0061       <span class="keyword">if</span> length(ff)&gt;1;
0062          imgn.node_data(ff) = 1+0.5*(k)/5; k=k+1;
0063         <span class="comment">%invEi = S(region0,ff)*inv(S(ff,ff))*S(ff,region0);</span>
0064          invEi =(S(region0,ff)/S(ff,ff))*S(ff,region0);
0065          regions(k) = struct(<span class="string">'nodes'</span>,ff,<span class="string">'field'</span>,i,<span class="string">'invE'</span>,invEi);
0066       <span class="keyword">end</span>;
0067    <span class="keyword">end</span>
0068 
0069    mr.main_region = region0;
0070    mr.regions = regions;
0071 
0072 <a name="_sub2" href="#_subfunctions" class="code">function do_unit_test</a>
0073    <span class="keyword">for</span> i=4:4; <span class="keyword">switch</span> i;
0074       <span class="keyword">case</span> 1; str = <span class="string">'a2c0'</span>;  tmdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(str,16);
0075       <span class="keyword">case</span> 2; str = <span class="string">'b2C2'</span>;  tmdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(str,16);
0076       <span class="keyword">case</span> 3; str = <span class="string">'a3cr'</span>;  tmdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(str,16);
0077       <span class="keyword">case</span> 4; str = <span class="string">'ngcyl'</span>; tmdl = <a href="../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>([1,1,.1],[16,0.5],0.1);
0078    <span class="keyword">end</span>
0079    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(tmdl,1);
0080    img.fwd_model.electrode = img.fwd_model.electrode([15,16,1:3]);
0081    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(5,1,[0,1],[0,1],{},1);
0082    img.fwd_model.stimulation = stim;
0083 
0084    pos = <a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(img.fwd_model);
0085    bl = find(pos(:,1)&lt;=0.2 &amp; pos(:,2)&lt;=0.5);
0086    br = find(pos(:,1)&gt;=0.2 &amp; pos(:,2)&lt;=0.5);
0087    img.elem_data(bl) = 0.9;
0088    img.elem_data(br) = 1.1;
0089    pgnode = zeros(1,<a href="mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(img)); pgnode(2) = 0.8;
0090    [~,img.fwd_model.gnd_node] = min(sum( <span class="keyword">...</span>
0091                bsxfun(@minus,img.fwd_model.nodes,pgnode).^2,2));
0092    c2f = 1+(1:<a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img));
0093    c2f(bl) = 1;
0094    c2f(br) = 2+<a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img);
0095    [~,idx2,idx] = unique(c2f); nc = length(idx2);
0096    c2f = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(1:<a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img),idx,1);
0097 
0098    img.elem_data = c2f*linspace(.7,1.3,length(idx2))';
0099 
0100    vs1 = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( img);
0101    
0102 
0103    imgmr = img; imgmr.fwd_model.model_reduction = @<a href="calc_model_reduction.html" class="code" title="function mr = calc_model_reduction(fmdl)">calc_model_reduction</a>;
0104    tic;
0105    vs2 = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( imgmr);
0106    fprintf(<span class="string">'t= %5.3fs:'</span>,toc);
0107    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([str,<span class="string">': 1-2'</span>],vs1.meas,vs2.meas,1e-10);
0108 
0109    img.fwd_model.coarse2fine = c2f;
0110    imgm3 = img;
0111    imgm3.fwd_model.model_reduction = <a href="calc_model_reduction.html" class="code" title="function mr = calc_model_reduction(fmdl)">calc_model_reduction</a>( imgm3.fwd_model);
0112    tic;
0113    vs3 = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( imgm3);
0114    fprintf(<span class="string">'t= %5.3fs:'</span>,toc);
0115    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([str,<span class="string">': 1-3'</span>],vs1.meas,vs3.meas,1e-10);
0116 
0117    imgm4 = img;
0118    imgm4.fwd_model.model_reduction = @<a href="calc_model_reduction.html" class="code" title="function mr = calc_model_reduction(fmdl)">calc_model_reduction</a>;
0119    tic;
0120    vs4 = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( imgm4);
0121    fprintf(<span class="string">'t= %5.3fs:'</span>,toc);
0122    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([str,<span class="string">': 1-4'</span>],vs1.meas,vs3.meas,1e-10);
0123    <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 01-Jun-2018 15:59:55 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>