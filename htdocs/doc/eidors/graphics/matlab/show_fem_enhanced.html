<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of show_fem_enhanced</title>
  <meta name="keywords" content="show_fem_enhanced">
  <meta name="description" content="SHOW_FEM: show the EIDORS3D finite element model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="#">graphics</a> &gt; <a href="index.html">matlab</a> &gt; show_fem_enhanced.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/graphics/matlab&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>show_fem_enhanced
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SHOW_FEM: show the EIDORS3D finite element model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function hh = show_fem(mdl, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SHOW_FEM: show the EIDORS3D finite element model
 hh = show_fem(mdl, options)
 mdl is an EIDORS3D 'model' or 'image' structure
 hh = handle to the plotted model

 options may be specified by a list (for compatibility purposes)

 options specifies a set of options
   options(1) =&gt; show colourbar
   options(2) =&gt; show numbering on electrodes
   options(3) =&gt; number elements (==1) or nodes (==2);

 for detailed control of colours, use the following fields (default values
 are indicated in parenthesis)

     options.viewpoint.az (-37.5)
     options.viewpoint.el (30.0)
 
     options.edge.color ([0 0 0])
     options.edge.width (0.5)
     options.edge.significant.show (true)
     options.edge.significant.color ([0 0 0])
     options.edge.significant.width (2)
     options.edge.significant.angle (45)
     options.edge.significant.viewpoint_dependent.show (true)
     options.edge.significant.viewpoint_dependent.color ([0 0 0])
     options.edge.significant.viewpoint_dependent.width (2)
     options.edge.significant.viewpoint_dependent.callback (true)
  
     options.colorbar.show (false)
 
     options.electrode.number.show (false)
     options.electrode.number.font_size (10)
     options.electrode.number.font_weight ('bold')
     options.electrode.number.color ([.6 0 0])
     options.electrode.number.background_color ('none')
     options.electrode.number.scale_position (1.15)
 
     options.element.number.show (false)
     options.element.number.font_size (7)
     options.element.number.font_weight ('normal')
     options.element.number.color ([0 0 0])
     options.element.number.background_color ('none')

     options.node.number.show (false)
     options.node.number.font_size (7)
     options.node.number.font_weight ('normal')
     options.node.number.color ([0 0 0.5])
     options.node.number.background_color ([1 1 1])

 EXAMPLES
   mdl = mk_common_model('c2C2',8);
   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));
   
 SET PARAMETERS
   img.show_fem.electrode.number.scale_position= 1.01;
   img.show_fem.electrode.number.show =1;
   show_fem(img)

 SET OPTIONS
   opts.colorbar.show = 1;
   show_fem(img.opts)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>	EIDORS_COLOURBAR - create an eidors colourbar with scaling to image</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/meshing/netgen/ng_mk_geometric_models.html" class="code" title="function [fmdl, mat_idx] = ng_mk_geometric_models(body_geometry, electrode_geometry)">ng_mk_geometric_models</a>	NG_MK_GEOMETRIC_MODELS: create geometric mesh models using Netgen. Body</li><li><a href="../../../eidors/models/elec_rearrange.html" class="code" title="function [elec_idx, new_fmdl] = elec_rearrange( pattern, newarrange, fwd_model )">elec_rearrange</a>	ELEC_REARRANGE: rearrange electrodes for given pattern</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a></li><li><a href="#_sub2" class="code">function refresh_current_axis(obj, evd)</a></li><li><a href="#_sub3" class="code">function hh = draw_all(img, mdl, opts)</a></li><li><a href="#_sub4" class="code">function hh = draw_fem(img, mdl, opts)</a></li><li><a href="#_sub5" class="code">function draw_numbers(positions, opts)</a></li><li><a href="#_sub6" class="code">function hh = draw_markers(points, colour, marker_size)</a></li><li><a href="#_sub7" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a></li><li><a href="#_sub8" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data,</a></li><li><a href="#_sub9" class="code">function colour = electr_colour(e, colormap_width)</a></li><li><a href="#_sub10" class="code">function mdl = find_sub_elements(mdl)</a></li><li><a href="#_sub11" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a></li><li><a href="#_sub12" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function hh = show_fem(mdl, options)</a>
0002 <span class="comment">% SHOW_FEM: show the EIDORS3D finite element model</span>
0003 <span class="comment">% hh = show_fem(mdl, options)</span>
0004 <span class="comment">% mdl is an EIDORS3D 'model' or 'image' structure</span>
0005 <span class="comment">% hh = handle to the plotted model</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% options may be specified by a list (for compatibility purposes)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% options specifies a set of options</span>
0010 <span class="comment">%   options(1) =&gt; show colourbar</span>
0011 <span class="comment">%   options(2) =&gt; show numbering on electrodes</span>
0012 <span class="comment">%   options(3) =&gt; number elements (==1) or nodes (==2);</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% for detailed control of colours, use the following fields (default values</span>
0015 <span class="comment">% are indicated in parenthesis)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%     options.viewpoint.az (-37.5)</span>
0018 <span class="comment">%     options.viewpoint.el (30.0)</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%     options.edge.color ([0 0 0])</span>
0021 <span class="comment">%     options.edge.width (0.5)</span>
0022 <span class="comment">%     options.edge.significant.show (true)</span>
0023 <span class="comment">%     options.edge.significant.color ([0 0 0])</span>
0024 <span class="comment">%     options.edge.significant.width (2)</span>
0025 <span class="comment">%     options.edge.significant.angle (45)</span>
0026 <span class="comment">%     options.edge.significant.viewpoint_dependent.show (true)</span>
0027 <span class="comment">%     options.edge.significant.viewpoint_dependent.color ([0 0 0])</span>
0028 <span class="comment">%     options.edge.significant.viewpoint_dependent.width (2)</span>
0029 <span class="comment">%     options.edge.significant.viewpoint_dependent.callback (true)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%     options.colorbar.show (false)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%     options.electrode.number.show (false)</span>
0034 <span class="comment">%     options.electrode.number.font_size (10)</span>
0035 <span class="comment">%     options.electrode.number.font_weight ('bold')</span>
0036 <span class="comment">%     options.electrode.number.color ([.6 0 0])</span>
0037 <span class="comment">%     options.electrode.number.background_color ('none')</span>
0038 <span class="comment">%     options.electrode.number.scale_position (1.15)</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%     options.element.number.show (false)</span>
0041 <span class="comment">%     options.element.number.font_size (7)</span>
0042 <span class="comment">%     options.element.number.font_weight ('normal')</span>
0043 <span class="comment">%     options.element.number.color ([0 0 0])</span>
0044 <span class="comment">%     options.element.number.background_color ('none')</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%     options.node.number.show (false)</span>
0047 <span class="comment">%     options.node.number.font_size (7)</span>
0048 <span class="comment">%     options.node.number.font_weight ('normal')</span>
0049 <span class="comment">%     options.node.number.color ([0 0 0.5])</span>
0050 <span class="comment">%     options.node.number.background_color ([1 1 1])</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% EXAMPLES</span>
0053 <span class="comment">%   mdl = mk_common_model('c2C2',8);</span>
0054 <span class="comment">%   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% SET PARAMETERS</span>
0057 <span class="comment">%   img.show_fem.electrode.number.scale_position= 1.01;</span>
0058 <span class="comment">%   img.show_fem.electrode.number.show =1;</span>
0059 <span class="comment">%   show_fem(img)</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% SET OPTIONS</span>
0062 <span class="comment">%   opts.colorbar.show = 1;</span>
0063 <span class="comment">%   show_fem(img.opts)</span>
0064 
0065 <span class="comment">% (C) 2015 Herve Gagnon. License: GPL version 2 or version 3</span>
0066 <span class="comment">% $Id: show_fem_enhanced.m 4778 2015-03-25 11:03:21Z aadler $</span>
0067 
0068 <span class="comment">% TESTS</span>
0069 <span class="keyword">switch</span> nargin
0070     <span class="keyword">case</span> 0
0071         error(<span class="string">'Insufficient parameters for show_fem'</span>);
0072     <span class="keyword">case</span> 1
0073         <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>); 
0074             <a href="#_sub12" class="code" title="subfunction do_unit_test">do_unit_test</a>; 
0075             <span class="keyword">return</span>; 
0076         <span class="keyword">end</span>
0077         <span class="keyword">if</span> (isstruct(mdl) &amp;&amp; isfield(mdl, <span class="string">'show_fem'</span>))
0078             options = mdl.show_fem;
0079         <span class="keyword">else</span>
0080             options = [];
0081         <span class="keyword">end</span>
0082     <span class="keyword">case</span> 2
0083         <span class="comment">% No special processing</span>
0084     <span class="keyword">otherwise</span>
0085         error(<span class="string">'Too many parameters for show_fem'</span>);
0086 <span class="keyword">end</span>
0087 
0088 [img, mdl, opts] = <a href="#_sub1" class="code" title="subfunction [img, mdl, opts] = proc_params(mdl, src_opts)">proc_params</a>(mdl, options);
0089 
0090 <span class="keyword">if</span> ~ishold
0091     cla;
0092 <span class="keyword">end</span>
0093 
0094 mdl = <a href="#_sub10" class="code" title="subfunction mdl = find_sub_elements(mdl)">find_sub_elements</a>(mdl);
0095 
0096 <span class="comment">% Convert nodes to 3D if necessary.</span>
0097 mdl.nodes = mdl.nodes*eye(size(mdl.nodes, 2), 3);
0098 
0099 hh = <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(img, mdl, opts);
0100 
0101 <span class="comment">% Setup callback function.</span>
0102 <span class="keyword">if</span> (opts.edge.significant.viewpoint_dependent.callback)
0103     h3d = rotate3d;
0104     set(gca, <span class="string">'UserData'</span>, struct(<span class="string">'name'</span>, <span class="string">'show_fem_data'</span>, <span class="string">'img'</span>, img, <span class="string">'mdl'</span>, mdl, <span class="string">'opts'</span>, opts));
0105     set(h3d, <span class="string">'ActionPostCallback'</span> , @<a href="#_sub2" class="code" title="subfunction refresh_current_axis(obj, evd)">refresh_current_axis</a>)
0106 <span class="keyword">end</span>
0107 
0108 <span class="keyword">if</span> (nargout == 0)
0109     clear hh; 
0110 <span class="keyword">end</span>
0111 
0112 <a name="_sub1" href="#_subfunctions" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a>
0113 
0114     <span class="comment">% Assign default viewpoint option values.</span>
0115     opts.viewpoint.az = -37.5;
0116     opts.viewpoint.el =  30.0;
0117 
0118     <span class="comment">% Assign default edge option values.</span>
0119     opts.edge.color   = [0 0 0];
0120     opts.edge.width   = 0.5;
0121     opts.edge.significant.show  = true;
0122     opts.edge.significant.color = [0 0 0];
0123     opts.edge.significant.width = 2;
0124     opts.edge.significant.angle = 45;
0125     opts.edge.significant.viewpoint_dependent.show     = true;
0126     opts.edge.significant.viewpoint_dependent.color    = [0 0 0];
0127     opts.edge.significant.viewpoint_dependent.width    = 2;
0128     opts.edge.significant.viewpoint_dependent.callback = true;
0129  
0130     <span class="comment">% Assign default colorbar option values.</span>
0131     opts.colorbar.show = false;
0132 
0133     <span class="comment">% Assign default electrode option values.</span>
0134     opts.electrode.number.show             = false;
0135     opts.electrode.number.font_size        = 10;
0136     opts.electrode.number.font_weight      = <span class="string">'bold'</span>;
0137     opts.electrode.number.color            = [.6 0 0];
0138     opts.electrode.number.background_color = <span class="string">'none'</span>;
0139     opts.electrode.number.scale_position   = 1.15;
0140 
0141     <span class="comment">% Assign default element option values.</span>
0142     opts.element.number.show             = false;
0143     opts.element.number.font_size        = 7;
0144     opts.element.number.font_weight      = <span class="string">'normal'</span>;
0145     opts.element.number.color            = [0 0 0];
0146     opts.element.number.background_color = <span class="string">'none'</span>;
0147 
0148     <span class="comment">% Assign default node option values.</span>
0149     opts.node.number.show             = false;
0150     opts.node.number.font_size        = 7;
0151     opts.node.number.font_weight      = <span class="string">'normal'</span>;
0152     opts.node.number.color            = [0 0 0.5];
0153     opts.node.number.background_color = [1 1 1];
0154 
0155     <span class="comment">% Override some defaults in 2D</span>
0156     <span class="keyword">if</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>( mdl ) == 2
0157        opts.viewpoint.az = 0;
0158        opts.viewpoint.el = 90;
0159        opts.electrode.number.scale_position= 1.05;
0160     <span class="keyword">end</span>
0161     
0162     <span class="keyword">if</span> (nargin == 2)
0163         <span class="keyword">if</span> (isstruct(src_opts))
0164             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'az'</span>);
0165             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'el'</span>);
0166             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'color'</span>);
0167             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'width'</span>);
0168             
0169             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'edge'</span>))
0170                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'show'</span>);
0171                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'color'</span>);
0172                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'width'</span>);
0173                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'angle'</span>);
0174                 <span class="keyword">if</span> (isfield(src_opts.edge, <span class="string">'significant'</span>))
0175                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'show'</span>);
0176                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'color'</span>);
0177                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'width'</span>);
0178                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'callback'</span>);
0179                 <span class="keyword">end</span>
0180             <span class="keyword">end</span>
0181 
0182             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'colorbar'</span>, <span class="string">'show'</span>);
0183 
0184             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'electrode'</span>))
0185                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'show'</span>);
0186                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0187                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0188                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'color'</span>);
0189                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'background_color'</span>);
0190                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'scale_position'</span>);                
0191             <span class="keyword">end</span>
0192             
0193             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'element'</span>))
0194                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'show'</span>);
0195                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0196                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0197                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'color'</span>);
0198                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0199             <span class="keyword">end</span>
0200 
0201             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'node'</span>))
0202                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'show'</span>);
0203                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0204                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0205                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'color'</span>);
0206                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0207             <span class="keyword">end</span>
0208             
0209             
0210         <span class="keyword">else</span> <span class="comment">% Support options from old version of show_fem for compatibility.</span>
0211             <span class="comment">% fill in default options</span>
0212             optionstr = zeros(1, 100);
0213             optionstr(1:length(src_opts)) = src_opts;
0214 
0215             opts.colorbar.show         = optionstr(1);
0216             opts.electrode.number.show = optionstr(2);
0217             <span class="keyword">switch</span> optionstr(3)
0218                 <span class="keyword">case</span> 1
0219                     opts.element.number.show = 1;
0220                 <span class="keyword">case</span> 2
0221                     opts.node.number.show = 1;
0222                 <span class="keyword">case</span> 3
0223                     opts.element.number.show = 1;
0224                     opts.node.number.show = 1;
0225             <span class="keyword">end</span>
0226         <span class="keyword">end</span>
0227     <span class="keyword">end</span>
0228 
0229     <span class="comment">% Display first image if several images are available.</span>
0230     <span class="keyword">if</span> (numel(mdl) &gt; 1)
0231         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1);
0232         mdl = mdl(1);
0233     <span class="keyword">end</span>
0234  
0235     <span class="comment">% if we have an img input, define mdl</span>
0236     <span class="keyword">if</span> strcmp(mdl(1).type , <span class="string">'image'</span> )
0237         img = mdl;
0238         mdl = img.fwd_model;
0239     <span class="keyword">else</span>
0240         img = [];
0241     <span class="keyword">end</span>
0242 
0243 <a name="_sub2" href="#_subfunctions" class="code">function refresh_current_axis(obj, evd)</a>
0244 UserData = get(gca, <span class="string">'UserData'</span>);
0245 <span class="keyword">if</span> (all(isfield(UserData, {<span class="string">'name'</span>, <span class="string">'img'</span>, <span class="string">'mdl'</span>, <span class="string">'opts'</span>})) &amp;&amp; <span class="keyword">...</span>
0246         strcmp(UserData.name, <span class="string">'show_fem_data'</span>))
0247     [az, el] = view(gca);
0248     <span class="keyword">if</span> (az ~= UserData.opts.viewpoint.az || el ~= UserData.opts.viewpoint.el)
0249         UserData.opts.viewpoint.az = az;
0250         UserData.opts.viewpoint.el = el;
0251         cla;
0252         <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(UserData.img, UserData.mdl, UserData.opts);
0253         set(gca, <span class="string">'UserData'</span>, UserData);
0254     <span class="keyword">end</span>
0255 <span class="keyword">end</span>
0256 
0257 <a name="_sub3" href="#_subfunctions" class="code">function hh = draw_all(img, mdl, opts)</a>
0258 
0259     hh = <a href="#_sub4" class="code" title="subfunction hh = draw_fem(img, mdl, opts)">draw_fem</a>(img, mdl, opts);
0260 
0261     <span class="comment">% Number elements if necessary.</span>
0262     <span class="keyword">if</span> (opts.element.number.show)
0263         <a href="#_sub5" class="code" title="subfunction draw_numbers(positions, opts)">draw_numbers</a>(<a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(mdl), opts.element.number);
0264     <span class="keyword">end</span>
0265 
0266     <span class="comment">% Number nodes if necessary.</span>
0267     <span class="keyword">if</span> (opts.node.number.show)
0268         <a href="#_sub5" class="code" title="subfunction draw_numbers(positions, opts)">draw_numbers</a>(mdl.nodes, opts.node.number);
0269     <span class="keyword">end</span>
0270 
0271     <span class="comment">% Number electrodes if necessary.</span>
0272     <span class="keyword">if</span> (opts.electrode.number.show &amp;&amp; isfield(mdl, <span class="string">'electrode'</span>))
0273         n_elec = numel(mdl.electrode);
0274         mesh_center = ones(n_elec, 1)*mean(mdl.nodes, 1);
0275 
0276         elec_pos = zeros(n_elec, size(mesh_center, 2));
0277 
0278         <span class="keyword">for</span> i = 1:n_elec
0279             <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0280                 elec_pos(i, :) = mean(mdl.nodes(mdl.electrode(i).nodes, :), 1);
0281             <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0282                 elec_pos(i, :) = mean(mdl.electrode(i).pos, 1)*eye(size(<span class="keyword">...</span>
0283                                                         elec_pos(i, :), 2), 3);
0284             <span class="keyword">end</span>
0285         <span class="keyword">end</span>
0286 
0287         <a href="#_sub5" class="code" title="subfunction draw_numbers(positions, opts)">draw_numbers</a>(opts.electrode.number.scale_position*(elec_pos - mesh_center) + mesh_center, opts.electrode.number);
0288     <span class="keyword">end</span>
0289 
0290     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)  
0291         view(opts.viewpoint.az, opts.viewpoint.el);
0292     <span class="keyword">end</span>
0293 
0294     axis image;
0295     
0296 <a name="_sub4" href="#_subfunctions" class="code">function hh = draw_fem(img, mdl, opts)</a>
0297     
0298     <span class="comment">% Assign colors and alpha to elements.</span>
0299     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0300         <span class="keyword">if</span> ~isempty(img)
0301             elems = mdl.sub_elements;
0302             electrode_field = <span class="string">'sub_elements'</span>;
0303         <span class="keyword">else</span>
0304             elems = mdl.boundary;
0305             electrode_field = <span class="string">'boundary'</span>;
0306         <span class="keyword">end</span>
0307         triangle_alpha = 0.5*ones(size(elems, 1), 1);
0308         triangle_edge_color = <span class="string">'none'</span>;
0309         triangle_edge_width = 0.5;
0310         
0311         <span class="comment">% Color mesh edges.</span>
0312         edge_edges = mdl.boundary_edges;
0313         edge_width = ones(size(edge_edges, 1), 1)*opts.edge.width;
0314         edge_color = ones(size(edge_edges, 1), 1)*opts.edge.color;
0315         
0316         <span class="keyword">if</span> opts.edge.significant.show
0317             <span class="keyword">if</span> opts.edge.significant.viewpoint_dependent.show 
0318                 <span class="comment">% Highlight profile of boundary according to viewing angle.</span>
0319                 T = viewmtx(opts.viewpoint.az, opts.viewpoint.el);
0320                 transformed_boundary_normal_vector = mdl.boundary_normal_vector*T(1:3,1:3)';
0321                 boundary_edges_idx2 = (transformed_boundary_normal_vector(mdl.edge2boundary(:, 1), 3).*transformed_boundary_normal_vector(mdl.edge2boundary(:, 2), 3) &lt;= 0);
0322 
0323                 edge_width(boundary_edges_idx2)    = opts.edge.significant.viewpoint_dependent.width;
0324                 edge_color(boundary_edges_idx2, :) = ones(sum(boundary_edges_idx2), 1)*opts.edge.significant.viewpoint_dependent.color;
0325             <span class="keyword">end</span>
0326 
0327             <span class="comment">% Highlight significant edges where boundary shape bends more than</span>
0328             <span class="comment">% 45 degrees.</span>
0329             boundary_edges_idx = dot(mdl.boundary_normal_vector(<span class="keyword">...</span>
0330                                      mdl.edge2boundary(:, 1), :), <span class="keyword">...</span>
0331                                      mdl.boundary_normal_vector(<span class="keyword">...</span>
0332                                      mdl.edge2boundary(:, 2), :), 2) <span class="keyword">...</span>
0333                                      &lt;= cosd(opts.edge.significant.angle);
0334             edge_width(boundary_edges_idx)    = opts.edge.significant.width;
0335             edge_color(boundary_edges_idx, :) = ones(sum(boundary_edges_idx), 1)*opts.edge.significant.color;
0336         <span class="keyword">end</span>
0337     <span class="keyword">else</span>
0338         elems = mdl.elems;
0339         electrode_field = <span class="string">'boundary'</span>;
0340         triangle_alpha = ones(size(elems, 1), 1);
0341         triangle_edge_color = opts.edge.color;
0342         triangle_edge_width = opts.edge.width;
0343         
0344         <span class="comment">% Highlight mesh boundary.</span>
0345         <span class="keyword">if</span> opts.edge.significant.show
0346             edge_edges = mdl.boundary;
0347             edge_width = opts.edge.significant.width*ones(size(edge_edges, 1), 1);
0348             edge_color = ones(size(edge_edges, 1), 1)*opts.edge.significant.color;
0349         <span class="keyword">else</span>
0350             edge_edges = [];
0351         <span class="keyword">end</span>
0352     <span class="keyword">end</span>
0353     
0354     <span class="keyword">if</span> ~isempty(img)
0355         <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0356             triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(mdl.element2sub_element*<span class="keyword">...</span>
0357                                 <a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img), img);
0358 
0359             factor = 3/8;
0360             
0361             alpha_map = zeros(size(colormap, 1), 1);
0362             alpha = linspace(0, 1, round(size(colormap, 1)*factor))';
0363             alpha_map(1:size(alpha, 1)) = alpha(end:-1:1);
0364             alpha_map(end:-1:(end-size(alpha, 1)+1)) = alpha(end:-1:1);
0365             
0366             factor = 3/8;
0367             alpha_map2 = ones(size(colormap, 1), 1);
0368             alpha2 = linspace(0, 1, round(size(colormap, 1)*factor))';
0369             alpha_map2((1:size(alpha2, 1)) + size(colormap, 1)/2) = alpha2;
0370             alpha_map2((end:-1:(end-size(alpha2, 1)+1)) - size(colormap, 1)/2) = alpha2;
0371             
0372             factor = 3/8;
0373             alpha_map3 = ones(size(colormap, 1), 1);
0374             alpha3 = linspace(0, 1, round(size(colormap, 1)*factor))';
0375             idx1 = (size(colormap, 1)/2 - size(alpha3, 1))/2;
0376             alpha_map3((-idx1:idx1) + size(colormap, 1)/2) = 0;
0377             alpha_map3((1:size(alpha3, 1)) + size(colormap, 1)/2 + (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0378             alpha_map3((end:-1:(end-size(alpha3, 1)+1)) - size(colormap, 1)/2 - (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0379     
0380             triangle_alpha = alpha_map3(triangle_color);
0381             
0382             <span class="comment">% Restore transparency for boundary elements;</span>
0383             alpha_idx =  triangle_alpha(mdl.boundary_to_sub_element_idx, :) &lt; 0.5;
0384             triangle_alpha(mdl.boundary_to_sub_element_idx(alpha_idx), :) = 0.5;
0385         <span class="keyword">else</span>
0386             triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img);
0387         <span class="keyword">end</span>
0388         triangle_color = squeeze(triangle_color(:, 1, :));
0389     <span class="keyword">else</span>
0390         triangle_color = ones(size(elems, 1), 1)*[1 1 1];
0391     <span class="keyword">end</span>
0392     
0393     <span class="comment">% Assign colors for electrodes.</span>
0394     marker_position = [];
0395     marker_color    = [];
0396     
0397     <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0398         <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0399             <span class="keyword">if</span> (isfield(mdl.electrode(i), electrode_field) &amp;&amp; <span class="keyword">...</span>
0400                     ~isempty(mdl.electrode(i).(electrode_field)))
0401                 
0402                 <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0403                     triangle_color(<span class="keyword">...</span>
0404                         mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0405                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0406                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(e, colormap_width)">electr_colour</a>(i, size(triangle_color, 2));
0407 
0408                     triangle_alpha(mdl.electrode(i).(electrode_field), <span class="keyword">...</span>
0409                                                                     :) = 1;
0410                     <span class="comment">% Highlight electrode edges.</span>
0411                     boundary_edges = [mdl.electrode(i).boundary_inner_edges;
0412                                       mdl.electrode(i).boundary_outer_edges];
0413                     edge_color(boundary_edges, :) = 0.5*ones(size(<span class="keyword">...</span>
0414                         boundary_edges, 1), 1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(e, colormap_width)">electr_colour</a>(i, 3);
0415                     edge_width(mdl.electrode(i).boundary_outer_edges) = 1;
0416                 <span class="keyword">else</span>
0417 
0418                     edge_width(mdl.electrode(i).(electrode_field), :) = 3;
0419                     edge_color(mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0420                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0421                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(e, colormap_width)">electr_colour</a>(i, 3);
0422                 <span class="keyword">end</span>
0423             <span class="keyword">else</span>
0424                 <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0425                     marker_position(end + 1, :) = mean(mdl.nodes(<span class="keyword">...</span>
0426                                             mdl.electrode(i).nodes, :), 1);
0427                 <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0428                     marker_position(end + 1, :) = mean(<span class="keyword">...</span>
0429                                                mdl.electrode(i).pos, 1)*<span class="keyword">...</span>
0430                                   eye(size(marker_position(<span class="keyword">end</span>, :), 2), 3);
0431                 <span class="keyword">end</span>
0432                 marker_color(end + 1, :) = <a href="#_sub9" class="code" title="subfunction colour = electr_colour(e, colormap_width)">electr_colour</a>(i, 3);
0433             <span class="keyword">end</span>
0434         <span class="keyword">end</span>
0435     <span class="keyword">end</span>
0436 
0437     <span class="comment">% Draw triangles</span>
0438     hh = <a href="#_sub8" class="code" title="subfunction hh = draw_triangles(faces, vertices, color_data, alpha_data, ">draw_triangles</a>(elems, mdl.nodes, <span class="keyword">...</span>
0439                       triangle_color, triangle_alpha, <span class="keyword">...</span>
0440                       triangle_edge_color, triangle_edge_width);
0441 
0442     <span class="comment">% Draw edges if necessary</span>
0443     <span class="keyword">if</span> (~isempty(edge_edges))
0444         <a href="#_sub7" class="code" title="subfunction hh = draw_edges(edges, vertices, width_data, color_data)">draw_edges</a>(edge_edges, mdl.nodes, edge_width, edge_color);
0445     <span class="keyword">end</span>
0446                   
0447     <span class="comment">% Draw markers if necessary.</span>
0448     <span class="keyword">if</span> (~isempty(marker_position))
0449         <a href="#_sub6" class="code" title="subfunction hh = draw_markers(points, colour, marker_size)">draw_markers</a>(marker_position, marker_color, 9);
0450     <span class="keyword">end</span>
0451 
0452     <span class="keyword">if</span> opts.colorbar.show &amp;&amp; ~isempty( img )
0453 <span class="comment">%       psave = get(gca,'position');</span>
0454         <a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>( img ); 
0455 <span class="comment">%       set(gca,'position',psave); %%% Reset axes after colourbar and move</span>
0456     <span class="keyword">end</span>
0457     
0458 <a name="_sub5" href="#_subfunctions" class="code">function draw_numbers(positions, opts)</a>
0459     text(positions(:,1), positions(:,2), positions(:,3), <span class="keyword">...</span>
0460         arrayfun(@(x){int2str(x)}, 1:size(positions, 1)), <span class="keyword">...</span>
0461         <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="keyword">...</span>
0462         <span class="string">'VerticalAlignment'</span>,   <span class="string">'middle'</span>, <span class="keyword">...</span>
0463         <span class="string">'FontSize'</span>,            opts.font_size, <span class="keyword">...</span>
0464         <span class="string">'FontWeight'</span>,          opts.font_weight, <span class="keyword">...</span>
0465         <span class="string">'Color'</span>,               opts.color, <span class="keyword">...</span>
0466         <span class="string">'BackgroundColor'</span>,     opts.background_color);
0467 
0468 <a name="_sub6" href="#_subfunctions" class="code">function hh = draw_markers(points, colour, marker_size)</a>
0469     [unique_colour, unused, colour_idx] = unique(colour, <span class="string">'rows'</span>);
0470     
0471     <span class="keyword">for</span> i = 1:size(unique_colour, 1)
0472         points_idx = colour_idx == i;
0473         hh = line(points(points_idx, 1), points(points_idx, 2), <span class="keyword">...</span>
0474                   points(points_idx, 3), <span class="keyword">...</span>
0475                   <span class="string">'LineStyle'</span>, <span class="string">'none'</span>, <span class="keyword">...</span>
0476                   <span class="string">'Marker'</span>, <span class="string">'o'</span>, <span class="string">'MarkerSize'</span>, marker_size, <span class="keyword">...</span>
0477                   <span class="string">'MarkerFaceColor'</span>, unique_colour(i, :), <span class="keyword">...</span>
0478                   <span class="string">'MarkerEdgeColor'</span>, unique_colour(i, :));
0479     <span class="keyword">end</span>
0480         
0481 <a name="_sub7" href="#_subfunctions" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a>
0482     [unique_width_color_data, unused, width_color_idx] = <span class="keyword">...</span><span class="comment"> </span>
0483                                    unique([width_data color_data], <span class="string">'rows'</span>);                            
0484     <span class="keyword">for</span> i = 1:size(unique_width_color_data, 1)
0485         <span class="keyword">if</span> (unique_width_color_data(i, 1) &gt; 0)
0486             edge_idx = (width_color_idx == i);
0487             points_list = [];
0488             points_list(1:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0489                                            vertices(edges(edge_idx, 1), :);
0490             points_list(2:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0491                                            vertices(edges(edge_idx, 2), :);
0492             points_list(3:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0493                                        nan(size(edges(edge_idx, :), 1), 3);
0494             hh = line(points_list(:, 1), points_list(:, 2), <span class="keyword">...</span>
0495                       points_list(:, 3), <span class="string">'LineWidth'</span>, <span class="keyword">...</span>
0496                       unique_width_color_data(i, 1), <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="keyword">...</span>
0497                       <span class="string">'Color'</span>, unique_width_color_data(i, 2:end));
0498         <span class="keyword">end</span>
0499     <span class="keyword">end</span>
0500 
0501 <a name="_sub8" href="#_subfunctions" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data, </a><span class="keyword">...</span>
0502                              edge_color, edge_width)
0503                          
0504     <span class="keyword">if</span> (size(color_data, 1) == 1)
0505         color_data = ones(size(faces, 1), 1)*color_data;
0506         face_color = <span class="string">'flat'</span>;
0507     <span class="keyword">elseif</span> (size(color_data, 1) == size(faces, 1))
0508         face_color = <span class="string">'flat'</span>;
0509     <span class="keyword">elseif</span> (size(color_data, 1) == size(vertices, 1))
0510         face_color = <span class="string">'interp'</span>;        
0511     <span class="keyword">else</span>
0512         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: color data and mesh do not match. Showing grey'</span>, 1);
0513         color_data = 0.5*ones(size(faces, 1), 3);
0514         face_color = <span class="string">'flat'</span>;      
0515     <span class="keyword">end</span>
0516     
0517     <span class="keyword">if</span> (size(alpha_data, 1) == 1)
0518         alpha_data = ones(size(faces, 1), 1)*alpha_data;
0519         face_color = <span class="string">'flat'</span>;
0520     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(faces, 1))
0521         face_alpha = <span class="string">'flat'</span>;
0522     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(vertices, 1))
0523         face_alpha = <span class="string">'interp'</span>;          
0524     <span class="keyword">else</span>
0525         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: alpha data and mesh do not match. Showing opaque'</span>, 1);
0526         alpha_data = 1;
0527         face_alpha = <span class="string">'flat'</span>;        
0528     <span class="keyword">end</span>
0529 
0530     hh = patch(<span class="string">'Faces'</span>, faces, <span class="string">'Vertices'</span>, vertices, <span class="keyword">...</span>
0531                <span class="string">'AlphaDataMapping'</span>, <span class="string">'none'</span>, <span class="keyword">...</span>
0532                <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span>, <span class="keyword">...</span>
0533                <span class="string">'FaceVertexCData'</span>, color_data, <span class="keyword">...</span>
0534                <span class="string">'FaceVertexAlphaData'</span>, alpha_data, <span class="keyword">...</span>
0535                <span class="string">'FaceColor'</span>, face_color, <span class="string">'FaceAlpha'</span>, face_alpha, <span class="keyword">...</span>
0536                <span class="string">'EdgeColor'</span>, edge_color, <span class="string">'FaceLighting'</span>, <span class="string">'flat'</span>, <span class="keyword">...</span>
0537                <span class="string">'LineWidth'</span>, edge_width);
0538 
0539 <a name="_sub9" href="#_subfunctions" class="code">function colour = electr_colour(e, colormap_width)</a>
0540     <span class="keyword">switch</span> (e)
0541         <span class="keyword">case</span> 1
0542             desired_colour = [0 .7 0]; <span class="comment">% light green electrode #1</span>
0543         <span class="keyword">case</span> 2
0544             desired_colour = [0 .5 0]; <span class="comment">% mid-green electrode #2</span>
0545         <span class="keyword">otherwise</span>
0546             desired_colour = [0 .3 0]; <span class="comment">% dark green</span>
0547     <span class="keyword">end</span>
0548 
0549     <span class="keyword">switch</span>(colormap_width)
0550         <span class="keyword">case</span> 1
0551             map = colormap;
0552             colormap_idx = find(all(map == ones(size(map, 1), 1)* <span class="keyword">...</span>
0553                                                        desired_colour, 2));
0554             <span class="keyword">if</span> ~isempty(colormap_idx)
0555                 colour = colormap_idx;
0556             <span class="keyword">else</span>
0557                 map = [map; desired_colour];
0558                 colormap(map);
0559                 colour = size(map, 1);
0560             <span class="keyword">end</span>
0561         <span class="keyword">case</span> 3 
0562             colour = desired_colour;
0563         <span class="keyword">otherwise</span>
0564             error(<span class="string">'Invalid colormap width.'</span>);
0565     <span class="keyword">end</span>
0566     
0567 <a name="_sub10" href="#_subfunctions" class="code">function mdl = find_sub_elements(mdl)</a>
0568     <span class="keyword">if</span> (~isfield(mdl, <span class="string">'sub_elements'</span>))
0569         <span class="comment">% Number of nodes per elements.</span>
0570         n_nodes_per_elem = size(mdl.elems, 2);
0571         
0572         <span class="comment">% Find sub-elements.</span>
0573         combos= nchoosek(1:n_nodes_per_elem, n_nodes_per_elem - 1);
0574         mdl.sub_elements = sort( <span class="keyword">...</span>
0575                            reshape(mdl.elems(:, combos')', <span class="keyword">...</span>
0576                                    n_nodes_per_elem - 1, []), <span class="keyword">...</span>
0577                                  1)';
0578                        
0579         <span class="comment">% Vector that associates each sub-element with</span>
0580         <span class="comment">% corresponding element.</span>
0581         sub_element_idx = reshape(ones(n_nodes_per_elem, 1) <span class="keyword">...</span>
0582                                            *(1:size(mdl.elems, 1)),[] , 1);
0583                                        
0584         sub_element_other_node_idx = reshape((n_nodes_per_elem:-1:1)'<span class="keyword">...</span>
0585                                      *ones(1, size(mdl.elems, 1)), [] , 1);
0586                                  
0587         sub_element_other_node = mdl.elems(sub2ind(size(mdl.elems), sub_element_idx, sub_element_other_node_idx));
0588                        
0589         <span class="comment">% Remove duplicate sub-elements.</span>
0590         <span class="comment">% Previously specified &quot;SPORTED&quot; but that is default, and not</span>
0591         <span class="comment">%   available in older versions</span>
0592         [mdl.sub_elements, ia, ic] = unique(<span class="keyword">...</span>
0593                                        mdl.sub_elements, <span class="string">'rows'</span>);
0594                                    
0595          sub_element_other_node = sub_element_other_node(ia, :);                    
0596                                 
0597         <span class="comment">% Compute a matrix that converts a property defined on the elements</span>
0598         <span class="comment">% to a property defined on the sub-elements.</span>
0599         mdl.element2sub_element = <a href="../../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(ic, sub_element_idx, <span class="keyword">...</span>
0600                              ones(n_nodes_per_elem*size(mdl.elems, 1), 1));
0601                          
0602         <span class="comment">% Normalize each row to one to account for boundary sub-elements</span>
0603         <span class="comment">% and internal sub-elements.</span>
0604         mdl.element2sub_element = spdiags(1./sum(<span class="keyword">...</span>
0605                                      mdl.element2sub_element, 2), <span class="keyword">...</span>
0606                                     0, size(mdl.sub_elements, 1), <span class="keyword">...</span>
0607                       size(mdl.sub_elements, 1))*mdl.element2sub_element;
0608                   
0609         <span class="comment">% Extract boundary from sub-elements.</span>
0610         mdl.boundary = mdl.sub_elements;
0611         boundary_other_node = sub_element_other_node;
0612         mdl.boundary_to_sub_element_idx = (1:size(mdl.sub_elements, 1))';
0613 
0614         sorted_ic = sort(ic);
0615 
0616         mdl.boundary(sorted_ic(diff(sorted_ic) == 0), :) = [];
0617         boundary_other_node(sorted_ic(diff(sorted_ic) == 0), :) = [];
0618         mdl.boundary_to_sub_element_idx(sorted_ic(diff(sorted_ic) == 0)) = [];
0619       
0620         <span class="keyword">if</span> (size(mdl.boundary, 2) == 3)
0621             <span class="comment">% Compute normal vectors.</span>
0622             Node1 = mdl.nodes(mdl.boundary(:, 1), :);
0623             Node2 = mdl.nodes(mdl.boundary(:, 2), :);
0624             Node3 = mdl.nodes(mdl.boundary(:, 3), :);
0625             Node4 = mdl.nodes(boundary_other_node, :);
0626             mdl.boundary_normal_vector = cross(Node1 - Node2, <span class="keyword">...</span>
0627                                                Node3 - Node2, 2);
0628  
0629             <span class="comment">% Normalize normal vectors.</span>
0630             norm = 1./sqrt(sum(mdl.boundary_normal_vector <span class="keyword">...</span>
0631                                          .*mdl.boundary_normal_vector, 2));
0632             mdl.boundary_normal_vector = mdl.boundary_normal_vector <span class="keyword">...</span>
0633                                                         .*[norm norm norm];
0634               
0635             <span class="comment">% Check if normal is outward. If not, invert direction.</span>
0636             normal_vector_idx = dot(mdl.boundary_normal_vector, <span class="keyword">...</span>
0637                                                      Node4 - Node2, 2) &gt; 0;
0638             mdl.boundary_normal_vector(normal_vector_idx, :) = <span class="keyword">...</span>
0639                          -mdl.boundary_normal_vector(normal_vector_idx, :);
0640                                                     
0641             <span class="comment">% Find boundary edges.</span>
0642             mdl.boundary_edges = sort(reshape(mdl.boundary(:, <span class="keyword">...</span>
0643                                             nchoosek(1:3, 2)')', 2, []), 1)';
0644 
0645             <span class="comment">% Vector that associates each edge with its</span>
0646             <span class="comment">% corresponding two boundary elements.</span>
0647             sub_boundary_edges_idx = reshape(ones(3, 1) <span class="keyword">...</span>
0648                                        *(1:size(mdl.boundary, 1)), [] , 1);
0649 
0650             [mdl.boundary_edges, sorted_idx] = sortrows(mdl.boundary_edges);
0651 
0652             mdl.boundary_edges = mdl.boundary_edges(1:2:<span class="keyword">end</span>, :);
0653 
0654             mdl.edge2boundary = reshape(sub_boundary_edges_idx(<span class="keyword">...</span>
0655                                                       sorted_idx), 2, [])';               
0656         <span class="keyword">end</span>
0657 
0658         <span class="comment">% Extract electrode boundary if necessary.</span>
0659         <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0660             <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0661                 mdl.electrode(i).boundary = find(all(ismember(<span class="keyword">...</span>
0662                                 mdl.boundary, mdl.electrode(i).nodes), 2));
0663                 mdl.electrode(i).sub_elements = <span class="keyword">...</span>
0664                                     mdl.boundary_to_sub_element_idx( <span class="keyword">...</span>
0665                                                 mdl.electrode(i).boundary);
0666                 
0667                 <span class="comment">% Find electrode edges.</span>
0668                 <span class="keyword">if</span> (isfield(mdl, <span class="string">'boundary_edges'</span>))
0669                     edge_candidates = sum(ismember(mdl.edge2boundary, <span class="keyword">...</span>
0670                                             mdl.electrode(i).boundary), 2);
0671                     mdl.electrode(i).boundary_inner_edges = find(<span class="keyword">...</span>
0672                                                      edge_candidates == 2);
0673                     mdl.electrode(i).boundary_outer_edges = find(<span class="keyword">...</span>
0674                                                      edge_candidates == 1);                                           
0675                 <span class="keyword">end</span>
0676             <span class="keyword">end</span>
0677         <span class="keyword">end</span>
0678     <span class="keyword">end</span>
0679    
0680 <a name="_sub11" href="#_subfunctions" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a>
0681     <span class="keyword">if</span> (isfield(src_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0682         isfield(dest_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0683         isfield(src_struct.(parent_field_name), child_field_name))
0684             dest_struct.(parent_field_name).(child_field_name) = <span class="keyword">...</span>
0685                 src_struct.(parent_field_name).(child_field_name);
0686     <span class="keyword">end</span>
0687 
0688 <span class="comment">% TESTS:</span>
0689 <a name="_sub12" href="#_subfunctions" class="code">function do_unit_test</a>
0690    ver= <a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'interpreter_version'</span>);
0691    clf
0692 
0693    img=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8)); 
0694    img.elem_data= 3*sin(linspace(-2,2,<a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img))');
0695    subplot(3,4,1); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img.fwd_model,[0,0,1]) 
0696    title(<span class="string">'regular mesh numbered'</span>);
0697 
0698 <span class="keyword">if</span> ~ver.isoctave 
0699    imgn = rmfield(img,<span class="string">'elem_data'</span>);
0700    imgn.node_data= 3*sin(linspace(-5,5,<a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(img))');
0701    subplot(3,4,9); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn) 
0702    title(<span class="string">'interpolated node colours'</span>);
0703 <span class="keyword">end</span>
0704 
0705    img2(1) = img; img2(2) = img;
0706    subplot(3,4,2); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[1]);
0707    title(<span class="string">'colours with legend'</span>);
0708    subplot(3,4,3); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img2,[0,1]);
0709    title(<span class="string">'colours with legend'</span>);
0710    img.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0711    subplot(3,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[0,1,1]);
0712    title(<span class="string">'RGB colours'</span>);
0713    subplot(3,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img);
0714    title(<span class="string">'RGB colours'</span>);
0715 
0716    img.elem_data = [1:10];
0717    subplot(3,4,12);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img); <span class="comment">%Should show grey</span>
0718    title(<span class="string">'error -&gt; show grey'</span>);
0719 
0720 <span class="keyword">if</span> ~ver.isoctave
0721    imgn.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0722    subplot(3,4,10);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn,[0,1]) 
0723    title(<span class="string">'interpolated node colours'</span>);
0724 
0725 
0726    subplot(3,4,11);hh=<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn); set(hh,<span class="string">'EdgeColor'</span>,[0,0,1]);
0727    title(<span class="string">'with edge colours'</span>);
0728 
0729 <span class="keyword">end</span>
0730 
0731    img3=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]));
0732    img3.elem_data= randn(828,1);                       
0733    subplot(3,4,5); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3.fwd_model) 
0734    subplot(3,4,6); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1])
0735    subplot(3,4,7); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1])
0736    subplot(3,4,8); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1,1])</pre></div>
<hr><address>Generated on Fri 01-Jun-2018 15:59:55 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>